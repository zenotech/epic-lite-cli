<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPIC-UI - {{ project_name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="importmap">
        {
          "imports": {
            "@kitware/vtk.js/": "https://cdn.skypack.dev/@kitware/vtk.js/"
          }
        }
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css', v='1') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
</head>
<body class="bg-[#F7FAFC]">
    <div class="min-h-screen flex">
        <!-- Sidebar -->
        <div class="w-64 bg-white border-r border-[#E2E8F0] flex flex-col">
             <div class="p-6 border-b border-[#E2E8F0]">
              <a href="{{ url_for('index') }}" class="flex items-center gap-3">
                <img src="{{ url_for('static', filename='logo2.png') }}" alt="Logo" class="w-10 h-10 object-contain">
                <div>
                  <h1 class="font-semibold text-[#2C3E50]">Epic Project</h1>
                  <p class="text-xs text-[#718096]">{{ project_name }}</p>
                </div>
              </a>
            </div>
            <nav class="flex-1 p-4">
                <div class="space-y-1">
                    <button
                      onclick="setActiveTab('dashboard')"
                      class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-[#4A5568] hover:bg-[#F7FAFC]"
                      id="dashboard-tab"
                    >
                      <i data-lucide="home" class="w-5 h-5"></i>
                      <span class="font-medium">Dashboard</span>
                    </button>

                    <button
                      onclick="setActiveTab('jobs')"
                      class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors bg-[#E2E8F0] text-[#2C3E50]"
                      id="jobs-tab"
                    >
                      <i data-lucide="briefcase" class="w-5 h-5"></i>
                      <span class="font-medium">Jobs</span>
                    </button>

                    <button
                      onclick="setActiveTab('storage')"
                      class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-[#4A5568] hover:bg-[#F7FAFC]"
                      id="storage-tab"
                    >
                      <i data-lucide="hard-drive" class="w-5 h-5"></i>
                      <span class="font-medium">Storage</span>
                    </button>

                    <button
                      onclick="setActiveTab('settings')"
                      class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-[#4A5568] hover:bg-[#F7FAFC]"
                      id="settings-tab" style="display: none;"
                    >
                      <i data-lucide="settings" class="w-5 h-5"></i>
                      <span class="font-medium">Settings</span>
                    </button>
                  </div>
            </nav>
            <div class="p-4 border-t border-[#E2E8F0]">
                <div class="bg-gradient-to-br from-[#F7FAFC] to-[#E2E8F0] rounded-lg p-4 border border-[#E2E8F0]">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-[#4A5568]">Monthly Spend</span>
                    <i data-lucide="trending-up" class="w-4 h-4 text-[#4A5568]"></i>
                  </div>
                  <div class="text-2xl font-bold text-[#2C3E50] mb-1" id="current-spend">$0.00</div>
                  <div class="text-xs text-[#4A5568] mb-3">of <span id="spend-limit">$0.00</span> limit</div>
                  <div class="w-full bg-[#E2E8F0] rounded-full h-2">
                    <div id="spend-bar" class="bg-[#A0AEC0] h-2 rounded-full" style="width: 0%"></div>
                  </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="bg-white border-b border-[#E2E8F0] px-8 py-4">
                <div class="flex items-center justify-between">
                    <div>
                      <h2 class="text-2xl font-bold text-[#2C3E50]" id="header-title">Job Management</h2>
                      <p class="text-sm text-[#4A5568] mt-1" id="header-subtitle">Monitor and manage your computational jobs</p>
                    </div>

                    <div class="flex items-center gap-3">
                      <div class="relative hidden">
                        <button
                          onclick="toggleNotifications()"
                          class="p-2 hover:bg-[#F7FAFC] rounded-lg transition-colors relative"
                        >
                          <i data-lucide="bell" class="w-5 h-5 text-[#4A5568]"></i>
                          <span class="absolute top-1 right-1 w-2 h-2 bg-[#EF4444] rounded-full"></span>
                        </button>

                        <div id="notifications-dropdown" class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border border-[#E2E8F0] z-50 hidden">
                          <div class="p-4 border-b border-[#E2E8F0]">
                            <h3 class="font-semibold text-[#2C3E50]">Notifications</h3>
                          </div>
                          <div class="max-h-96 overflow-y-auto">
                            <!-- Notifications will be loaded here -->
                          </div>
                        </div>
                      </div>

                      <div class="flex items-center gap-2 px-3 py-2 bg-[#F7FAFC] rounded-lg">
                        <i data-lucide="user" class="w-4 h-4 text-[#4A5568]"></i>
                        <span class="text-sm font-medium text-[#4A5568]">{{ username }}</span>
                      </div>
                    </div>
                  </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-auto p-8">
                <div id="dashboard-content" class="tab-content hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white rounded-lg border border-[#E2E8F0] p-6">
                          <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-[#2C3E50]">Active Jobs</h3>
                            <i data-lucide="briefcase" class="w-5 h-5 text-[#3B82F6]"></i>
                          </div>
                          <div id="active-jobs-value" class="text-3xl font-bold text-[#2C3E50] mb-2">0</div>
                          <p id="active-jobs-desc" class="text-sm text-[#4A5568]">0 running, 0 queued</p>
                        </div>

                        <div class="bg-white rounded-lg border border-[#E2E8F0] p-6">
                          <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-[#2C3E50]">Storage Used</h3>
                            <i data-lucide="hard-drive" class="w-5 h-5 text-[#10B981]"></i>
                          </div>
                          <div id="storage-used-value" class="text-3xl font-bold text-[#2C3E50] mb-2">Loading...</div>
                          <p id="storage-used-desc" class="text-sm text-[#4A5568]">Loading...</p>
                        </div>

                        <div class="bg-white rounded-lg border border-[#E2E8F0] p-6">
                          <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-[#2C3E50]">This Month</h3>
                            <i data-lucide="calendar" class="w-5 h-5 text-[#8B5CF6]"></i>
                          </div>
                          <div id="this-month-value" class="text-3xl font-bold text-[#2C3E50] mb-2">$0.00</div>
                          <p id="this-month-desc" class="text-sm text-[#4A5568]">0% of budget used</p>
                        </div>
                      </div>

                      <div class="bg-white rounded-lg border border-[#E2E8F0] p-6">
                        <h3 class="font-semibold text-[#2C3E50] mb-4">Recent Activity</h3>
                        <div id="recent-activity-list" class="space-y-4">
                          <!-- Activity will be loaded here -->
                        </div>
                      </div>
                </div>
                <div id="jobs-content" class="tab-content space-y-6">
                    <div class="bg-white rounded-lg border border-[#E2E8F0] p-4">
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="relative flex-1 max-w-md">
                                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-[#A0AEC0]"></i>
                                    <input
                                      type="text"
                                      id="job-search-input"
                                      placeholder="Search jobs..."
                                      class="w-full pl-10 pr-4 py-2 border border-[#A0AEC0] rounded-lg focus:ring-2 focus:ring-[#A0AEC0] focus:border-transparent"
                                    />
                                  </div>
                                  <div class="flex items-center gap-2">
                                    <i data-lucide="filter" class="w-5 h-5 text-[#A0AEC0]"></i>
                                    <select
                                      id="job-status-filter"
                                      class="px-3 py-2 border border-[#A0AEC0] rounded-lg focus:ring-2 focus:ring-[#A0AEC0] focus:border-transparent"
                                    >
                                      <option value="all">All Status</option>
                                      <option value="COMPLETED">Completed</option>
                                      <option value="RUNNING">Running</option>
                                      <option value="QUEUED">Queued</option>
                                      <option value="FAILED">Failed</option>
                                    </select>
                                  </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="px-4 py-2 bg-[#2C3E50] text-white rounded-lg hover:bg-[#4A5568] transition-colors flex items-center gap-2" id="refresh-jobs">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    Refresh
                                  </button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border border-[#E2E8F0] overflow-hidden">
                        <div class="overflow-x-auto">
                            <div id="job-list">
                            <p class="text-[#4A5568] p-4">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="storage-content" class="tab-content hidden space-y-6">
                    <div class="bg-white rounded-lg border border-[#E2E8F0] p-4">
                        <div class="flex items-center justify-between">
                            <div id="s3-breadcrumbs" class="flex items-center gap-2 text-sm">
                                <!-- Breadcrumbs will be loaded here -->
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="s3-upload-button" class="px-4 py-2 bg-[#2C3E50] text-white rounded-lg hover:bg-[#4A5568] transition-colors flex items-center gap-2">
                                    <i data-lucide="upload" class="w-4 h-4"></i>
                                    Upload
                                </button>
                                <button id="s3-refresh-button" class="px-4 py-2 border border-[#A0AEC0] rounded-lg hover:bg-[#F7FAFC] transition-colors flex items-center gap-2">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border border-[#E2E8F0]">
                        <div id="s3-file-list" class="grid grid-cols-1 divide-y divide-[#E2E8F0]">
                            <!-- File list will be loaded here -->
                        </div>
                    </div>
                </div>
                <div id="settings-content" class="tab-content hidden">
                    <div class="bg-white rounded-lg border border-[#E2E8F0] p-6">
                        <h3 class="font-semibold text-[#2C3E50] mb-6">Project Settings</h3>
                        <div class="space-y-6">
                          <div>
                            <label class="block text-sm font-medium text-[#4A5568] mb-2">
                              Monthly Spend Limit
                            </label>
                            <input
                              type="number"
                              defaultValue="100"
                              class="w-full max-w-xs px-4 py-2 border border-[#A0AEC0] rounded-lg focus:ring-2 focus:ring-[#A0AEC0] focus:border-transparent"
                            />
                            <p class="text-sm text-[#718096] mt-2">Set the maximum monthly spend for this project</p>
                          </div>

                          <div>
                            <label class="block text-sm font-medium text-[#4A5568] mb-2">
                              Project Name
                            </label>
                            <input
                              type="text"
                              value="{{ project_name }}"
                              class="w-full max-w-xs px-4 py-2 border border-[#A0AEC0] rounded-lg focus:ring-2 focus:ring-[#A0AEC0] focus:border-transparent"
                            />
                          </div>

                          <div class="pt-4">
                            <button class="px-6 py-2 bg-[#2C3E50] text-white rounded-lg hover:bg-[#4A5568] transition-colors">
                              Save Changes
                            </button>
                          </div>
                        </div>
                      </div>
                </div>
            </main>
        </div>
    </div>
    <script src="static/vtk.js"></script>
    <script>
        let current_prefix = '';

        document.addEventListener('DOMContentLoaded', function() {
            loadBillingInfo();
            loadJobs();
            loadS3Browser();
            loadStorageStats();
            //loadDashboardData();
            loadNotifications();
            lucide.createIcons({ root: document.body });

            document.getElementById('refresh-jobs').addEventListener('click', loadJobs);

            $('#job-search-input').on('keyup', function() {
                $('#jobs-table').DataTable().search($(this).val()).draw();
            });

            $('#job-status-filter').on('change', function() {
                if ($(this).val() === 'all') {
                    $('#jobs-table').DataTable().column(3).search('').draw();
                } else {
                    $('#jobs-table').DataTable().column(3).search($(this).val()).draw();
                }
            });

            document.getElementById('s3-upload-button').addEventListener('click', () => document.getElementById('s3-upload-input').click());
            document.getElementById('s3-upload-input').addEventListener('change', handleS3Upload);
            document.getElementById('s3-refresh-button').addEventListener('click', () => loadS3Browser(current_prefix));
        });

        function loadBillingInfo() {
            fetch('/api/billing')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error fetching billing info:', data.error);
                        return;
                    }

                    const spendLimit = parseFloat(data.spend_limit.amount);
                    const currentSpend = parseFloat(data.current_spend.amount);
                    const currency = data.spend_limit.currency_symbol;

                    const spendPercentage = (currentSpend / spendLimit) * 100;

                    // Update sidebar
                    document.getElementById('spend-limit').textContent = currency + spendLimit.toFixed(2);
                    document.getElementById('current-spend').textContent = currency + currentSpend.toFixed(2);
                    document.getElementById('spend-bar').style.width = `${spendPercentage}%`;

                    // Update dashboard card
                    document.getElementById('this-month-value').textContent = currency + currentSpend.toFixed(2);
                    document.getElementById('this-month-desc').textContent = `${spendPercentage.toFixed(0)}% of budget used`;
                })
                .catch(error => {
                    console.error('Error fetching billing info:', error);
                });
        }

        function loadStorageStats() {
            fetch('/api/s3/bucket-size')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error fetching storage stats:', data.error);
                        document.getElementById('storage-used-value').textContent = 'Error';
                        document.getElementById('storage-used-desc').textContent = 'Could not load stats';
                        return;
                    }
                    document.getElementById('storage-used-value').textContent = formatBytes(data.total_size);
                    document.getElementById('storage-used-desc').textContent = `${data.total_objects.toLocaleString()} objects`;
                })
                .catch(error => {
                    console.error('Error fetching storage stats:', error);
                    document.getElementById('storage-used-value').textContent = 'Error';
                    document.getElementById('storage-used-desc').textContent = 'Could not load stats';
                });
        }

        function loadJobs() {
            const jobListDiv = document.getElementById('job-list');
            jobListDiv.innerHTML = '<p>Loading...</p>';

            fetch('/api/jobs')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        jobListDiv.innerHTML = `<p style="color: red;">${data.error}</p>`;
                        return;
                    }

                    if (data.length === 0) {
                        jobListDiv.innerHTML = '<p>No jobs found.</p>';
                        return;
                    }

                    // Calculate active jobs
                    const activeJobs = data.filter(job => ['RUNNING', 'QUEUED', 'PROVISIONING'].includes(job.status));
                    const runningJobs = data.filter(job => job.status === 'RUNNING').length;
                    const queuedJobs = data.filter(job => ['QUEUED', 'PROVISIONING'].includes(job.status)).length;
                    document.getElementById('active-jobs-value').textContent = activeJobs.length;
                    document.getElementById('active-jobs-desc').textContent = `${runningJobs} running, ${queuedJobs} queued`;

                    // Populate Recent Activity
                    const twelveHoursAgo = new Date(Date.now() - 12 * 60 * 60 * 1000);
                    const recentJobs = data
                        .filter(job => new Date(job.submitted_at) > twelveHoursAgo)
                        .sort((a, b) => new Date(b.submitted_at) - new Date(a.submitted_at))
                        .slice(0, 3);

                    const activityList = document.getElementById('recent-activity-list');
                    if (recentJobs.length > 0) {
                        activityList.innerHTML = recentJobs.map(job => `
                            <div class="flex items-start gap-3 p-3 bg-[#F7FAFC] rounded-lg">
                                <div class="w-2 h-2 mt-2 rounded-full bg-[#3B82F6]"></div>
                                <div class="flex-1">
                                    <p class="text-sm text-[#2C3E50]">Job "${job.name}" has status ${job.status}</p>
                                    <p class="text-xs text-[#4A5568] mt-1">${new Date(job.submitted_at).toLocaleString()}</p>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        activityList.innerHTML = '<p class="text-sm text-[#4A5568]">No recent activity in the last 12 hours.</p>';
                    }

                    let table = `
                        <table id="jobs-table" class="w-full">
                            <thead class="bg-[#F7FAFC] border-b border-[#E2E8F0]">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#4A5568] uppercase tracking-wider">Job Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#4A5568] uppercase tracking-wider">Submitted By</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#4A5568] uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#4A5568] uppercase tracking-wider">Created</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-[#4A5568] uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-[#E2E8F0]">
                    `;
                    data.forEach(job => {
                        const isCancelable = ['RUNNING', 'PENDING', 'SUBMITTED', 'RUNNABLE', 'STARTING', 'PROVISIONING'].includes(job.status);
                        const isViewable = ['RUNNING', 'COMPLETED', 'FAILED'].includes(job.status);
                        table += `
                            <tr class="hover:bg-[#F7FAFC] transition-colors">
                                <td class="px-6 py-4">
                                    <div class="font-medium text-[#2C3E50]" title="UUID: ${job.uuid}">${job.name}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-[#4A5568]">${job.submitted_by}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium border ${getStatusColor(job.status)}">
                                        <i data-lucide="${getStatusIcon(job.status)}" class="w-4 h-4"></i>
                                        ${job.status}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm text-[#4A5568]">
                                    ${new Date(job.submitted_at).toLocaleString()}
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <button class="p-2 hover:bg-[#E2E8F0] rounded-lg transition-colors" onclick="viewJobLogs('${job.uuid}')" ${isViewable ? '' : 'disabled'} title="View Logs">
                                            <i data-lucide="eye" class="w-4 h-4 text-[#4A5568]"></i>
                                        </button>
                                        <button class="p-2 hover:bg-[#E2E8F0] rounded-lg transition-colors" onclick="cancelJob('${job.uuid}')" ${isCancelable ? '' : 'disabled'} title="Cancel Job">
                                            <i data-lucide="trash-2" class="w-4 h-4 text-[#EF4444]"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    table += '</tbody></table>';
                    jobListDiv.innerHTML = table;
                    lucide.createIcons({ root: jobListDiv });
                    $('#jobs-table').DataTable({
                        "order": [[ 4, "desc" ]]
                    });
                })
                .catch(error => {
                    console.error('Error fetching jobs:', error);
                    jobListDiv.innerHTML = `<p style="color: red;">An error occurred.</p>`;
                });
        }

        async function viewJobLogs(jobUuid) {
            const modal = document.getElementById('file-viewer-modal');
            const fileContentDiv = document.getElementById('file-content');
            const closeButton = document.querySelector('.close-button');

            fileContentDiv.innerHTML = '<p>Loading logs...</p>';
            modal.style.display = 'block';

            try {
                const response = await fetch(`/api/job/${jobUuid}/tail`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to parse error JSON.' }));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.logs && Array.isArray(data.logs)) {
                    const logs = data.logs.map(log => log.message).join('\n');
                    fileContentDiv.innerHTML = `<pre>${escapeHtml(logs)}</pre>`;
                } else {
                    fileContentDiv.innerHTML = '<p>No logs available or in an unexpected format.</p>';
                }
            } catch (error) {
                console.error('View logs error:', error);
                fileContentDiv.innerHTML = `<p style="color: red;">Failed to load logs: ${error.message}</p>`;
            }

            closeButton.onclick = function() {
                modal.style.display = 'none';
                fileContentDiv.innerHTML = '';
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                    fileContentDiv.innerHTML = '';
                }
            }
        }

        function cancelJob(jobUuid) {
            if (!confirm('Are you sure you want to cancel this job?')) {
                return;
            }

            fetch(`/api/cancel_job/${jobUuid}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                    } else {
                        alert(data.message);
                        loadJobs();
                    }
                })
                .catch(error => {
                    console.error('Error cancelling job:', error);
                    alert('An error occurred while cancelling the job.');
                });
        }

        // S3 Browser Functions
        function loadS3Browser(prefix = '') {
            current_prefix = prefix;
            const fileListDiv = document.getElementById('s3-file-list');
            fileListDiv.innerHTML = '<p>Loading files...</p>';

            updateBreadcrumbs(prefix);

            fetch(`/api/s3/list?prefix=${prefix}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        fileListDiv.innerHTML = `<p style="color: red;">${data.error}</p>`;
                        return;
                    }
                    renderS3Files(data.folders, data.files);
                })
                .catch(error => {
                    console.error('Error fetching S3 file list:', error);
                    fileListDiv.innerHTML = `<p style="color: red;">An error occurred.</p>`;
                });
        }

        function updateBreadcrumbs(prefix) {
            const breadcrumbsDiv = document.getElementById('s3-breadcrumbs');
            breadcrumbsDiv.innerHTML = '';
            let path = '';
            const segments = prefix.split('/').filter(Boolean);

            const rootLink = document.createElement('button');
            rootLink.className = 'text-[#4A5568] hover:text-[#2C3E50] font-medium';
            rootLink.textContent = 'Bucket Root';
            rootLink.onclick = (e) => { e.preventDefault(); loadS3Browser(''); };
            breadcrumbsDiv.appendChild(rootLink);

            segments.forEach((segment, index) => {
                path += segment + '/';
                const separator = document.createElement('i');
                separator.setAttribute('data-lucide', 'chevron-right');
                separator.className = 'w-4 h-4 text-[#A0AEC0]';
                breadcrumbsDiv.appendChild(separator);

                const link = document.createElement('button');
                link.className = 'text-[#4A5568] hover:text-[#2C3E50] font-medium';
                link.textContent = segment;
                const currentPath = path;
                link.onclick = (e) => { e.preventDefault(); loadS3Browser(currentPath); };
                breadcrumbsDiv.appendChild(link);
            });
            lucide.createIcons({ root: breadcrumbsDiv });
        }

        function renderS3Files(folders, files) {
            const fileListDiv = document.getElementById('s3-file-list');
            let content = '';

            folders.forEach(folder => {
                const folderName = folder.replace(current_prefix, '').replace('/', '');
                content += `
                    <div class="p-4 hover:bg-[#F7FAFC] transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-[#E2E8F0]">
                                    <i data-lucide="folder" class="w-5 h-5 text-[#4A5568]"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="font-medium text-[#2C3E50] cursor-pointer" onclick="event.stopPropagation(); loadS3Browser('${folder}')">${folderName}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="p-2 hover:bg-[#E2E8F0] rounded-lg transition-colors" onclick="event.stopPropagation(); renameFolder('${folder}')" title="Rename"><i data-lucide="edit" class="w-4 h-4 text-[#4A5568]"></i></button>
                                <button class="p-2 hover:bg-[#E2E8F0] rounded-lg transition-colors" onclick="event.stopPropagation(); copyFolder('${folder}')" title="Copy"><i data-lucide="copy" class="w-4 h-4 text-[#4A5568]"></i></button>
                                <button class="p-2 hover:bg-[#E2E8F0] rounded-lg transition-colors" onclick="event.stopPropagation(); deleteFolder('${folder}')" title="Delete">
                                    <i data-lucide="trash-2" class="w-4 h-4 text-[#EF4444]"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            files.forEach(file => {
                const fileName = file.key.replace(current_prefix, '');
                content += `
                    <div class="p-4 hover:bg-[#F7FAFC] transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-[#F7FAFC]">
                                    <i data-lucide="file" class="w-5 h-5 text-[#4A5568]"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="font-medium text-[#2C3E50] cursor-pointer" onclick="event.stopPropagation(); viewFile('${file.key}')">${fileName}</div>
                                    <div class="text-sm text-[#718096]">${new Date(file.last_modified).toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-6">
                                <span class="text-sm text-[#4A5568] w-24 text-right">${formatBytes(file.size)}</span>
                                <div class="flex items-center gap-2">
                                    <button class="p-2 hover:bg-[#E2E8F0] rounded-lg transition-colors" onclick="event.stopPropagation(); viewFile('${file.key}')" title="View"><i data-lucide="eye" class="w-4 h-4 text-[#4A5568]"></i></button>
                                    <button class="p-2 hover:bg-[#E2E8F0] rounded-lg transition-colors" onclick="event.stopPropagation(); downloadFile('${file.key}')" title="Download">
                                        <i data-lucide="download" class="w-4 h-4 text-[#4A5568]"></i>
                                    </button>
                                    <button class="p-2 hover:bg-[#E2E8F0] rounded-lg transition-colors" onclick="event.stopPropagation(); renameFile('${file.key}')" title="Rename"><i data-lucide="edit" class="w-4 h-4 text-[#4A5568]"></i></button>
                                    <button class="p-2 hover:bg-[#E2E8F0] rounded-lg transition-colors" onclick="event.stopPropagation(); copyFile('${file.key}')" title="Copy"><i data-lucide="copy" class="w-4 h-4 text-[#4A5568]"></i></button>
                                    <button class="p-2 hover:bg-[#E2E8F0] rounded-lg transition-colors" onclick="event.stopPropagation(); deleteFile('${file.key}')" title="Delete">
                                        <i data-lucide="trash-2" class="w-4 h-4 text-[#EF4444]"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            fileListDiv.innerHTML = content;
            lucide.createIcons({ root: fileListDiv });
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function handleS3Upload(event) {
            const files = event.target.files;
            if (!files.length) return;

            for (const file of files) {
                const key = current_prefix + file.name;

                fetch('/api/s3/presigned-url/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: key })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    return fetch(data.url, { method: 'PUT', body: file });
                })
                .then(response => {
                    if (!response.ok) throw new Error('Upload failed.');
                    alert(`Successfully uploaded ${file.name}`);
                    loadS3Browser(current_prefix);
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    alert(`Failed to upload ${file.name}: ${error.message}`);
                });
            }
            // Reset input for next upload
            event.target.value = '';
        }

        async function downloadFile(key) {
            try {
                const response = await fetch('/api/s3/presigned-url/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: key })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const url = data.url;
                const savePath = await window.pywebview.api.save_file_dialog(key.split('/').pop() || 'download');

                if (savePath) {
                    const result = await window.pywebview.api.download_file(url, savePath);
                    if (result.status === 'success') {
                        alert(`File downloaded successfully to ${result.path}`);
                    } else {
                        alert(`Download failed: ${result.message}`);
                    }
                }
            } catch (error) {
                console.error('Error downloading file:', error);
                alert('Could not get download link.');
            }
        }

        function deleteFile(key) {
            if (!confirm(`Are you sure you want to delete ${key}?`)) return;

            fetch('/api/s3/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: key })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                alert(data.message);
                loadS3Browser(current_prefix);
            })
            .catch(error => {
                console.error('Delete error:', error);
                alert(`Failed to delete file: ${error.message}`);
            });
        }

        function renameFile(oldKey) {
            const newKey = prompt('Enter new path for the file:', oldKey);
            if (!newKey) return;

            fetch('/api/s3/rename', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ old_key: oldKey, new_key: newKey })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                alert(data.message);
                loadS3Browser(current_prefix);
            })
            .catch(error => {
                console.error('Rename error:', error);
                alert(`Failed to rename file: ${error.message}`);
            });
        }

        function copyFile(sourceKey) {
            const destKey = prompt('Enter new path for the copy:', sourceKey + '_copy');
            if (!destKey) return;

            fetch('/api/s3/copy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source_key: sourceKey, destination_key: destKey })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                alert(data.message);
                loadS3Browser(current_prefix);
            })
            .catch(error => {
                console.error('Copy error:', error);
                alert(`Failed to copy file: ${error.message}`);
            });
        }

        function deleteFolder(prefix) {
            if (!confirm(`Are you sure you want to delete the folder ${prefix} and all its contents?`)) return;

            fetch('/api/s3/delete-folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prefix: prefix })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                alert(data.message);
                loadS3Browser(current_prefix.startsWith(prefix) ? '' : current_prefix);
            })
            .catch(error => {
                console.error('Delete folder error:', error);
                alert(`Failed to delete folder: ${error.message}`);
            });
        }

        function renameFolder(oldPrefix) {
            const newPrefix = prompt('Enter new name for the folder:', oldPrefix);
            if (!newPrefix) return;

            fetch('/api/s3/rename-folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ old_prefix: oldPrefix, new_prefix: newPrefix })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                alert(data.message);
                loadS3Browser(current_prefix.startsWith(oldPrefix) ? '' : current_prefix);
            })
            .catch(error => {
                console.error('Rename folder error:', error);
                alert(`Failed to rename folder: ${error.message}`);
            });
        }

        function copyFolder(sourceFolder) {
            let folderName = sourceFolder.endsWith('/') ? sourceFolder.slice(0, -1) : sourceFolder;
            const destFolder = prompt('Enter new path for the copy:', folderName + '_copy');
            if (!destFolder) return;

            fetch('/api/s3/copy-folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source_folder: sourceFolder, destination_folder: destFolder })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                alert(data.message);
                loadS3Browser(current_prefix);
            })
            .catch(error => {
                console.error('Copy folder error:', error);
                alert(`Failed to copy folder: ${error.message}`);
            });
        }

        async function viewFile(key) {
            const modal = document.getElementById('file-viewer-modal');
            const fileContentDiv = document.getElementById('file-content');
            const closeButton = document.querySelector('.close-button');
            let vtkCleanup = () => {}; // No-op cleanup function by default

            // Clear previous content and show loading message
            fileContentDiv.innerHTML = '<p>Loading...</p>';
            modal.style.display = 'block';

            if (key.toLowerCase().endsWith('.png')) {
                fileContentDiv.innerHTML = `<img src="/api/s3/view/${key}" alt="${key}" style="max-width: 100%; height: auto;">`;
            } else if (key.toLowerCase().endsWith('.vtp')) {

                // Create the container
                const container = document.createElement('div');
                container.id = 'vtk-container';
                container.style.cssText = 'width: 100%; height: 100%; flex: 1 1 auto;';

                // Clear and append
                fileContentDiv.innerHTML = '';
                fileContentDiv.appendChild(container);
                // fileContentDiv.innerHTML = '<div id="vtk-container" style="width: 100%; height: 100%; flex: 1 1 auto;"></div>';

                try {
                    // Dynamically import vtk.js modules
                    //const { default: vtkRenderWindow } = await import('@kitware/vtk.js/Rendering/Core/RenderWindow');
                    //const { default: vtkRenderer } = await import('@kitware/vtk.js/Rendering/Core/Renderer');
                    //const { default: vtkActor } = await import('@kitware/vtk.js/Rendering/Core/Actor');
                    //const { default: vtkMapper } = await import('@kitware/vtk.js/Rendering/Core/Mapper');
                    //const { default: vtkXMLPolyDataReader } = await import('@kitware/vtk.js/IO/XML/XMLPolyDataReader');
                    //const { default: vtkOpenGLRenderWindow } = await import('@kitware/vtk.js/Rendering/OpenGL/RenderWindow');
                    //const { default: vtkRenderWindowInteractor } = await import('@kitware/vtk.js/Rendering/Core/RenderWindowInteractor');
                    //const { default: vtkInteractorStyleTrackballCamera } = await import('@kitware/vtk.js/Interaction/Style/InteractorStyleTrackballCamera');

                    // Now initialize VTK.js with the reference you already have
                    const renderWindow = vtk.Rendering.Core.vtkRenderWindow.newInstance();
                    const openglRenderWindow = vtk.Rendering.OpenGL.vtkRenderWindow.newInstance();
                    openglRenderWindow.setContainer(container);  // Use the direct reference
                    renderWindow.addView(openglRenderWindow);

                    const response = await fetch(`/api/s3/view/${key}`, {
                            headers: { 'Accept': 'application/octet-stream' }
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    //console.log("Response headers:", [...response.headers.entries()]);

                    //const cloned = response.clone();
                    //const text = await cloned.text();
                    //console.log("First 1000 chars:", text.slice(0, 1000));

                    const fileContents = await response.arrayBuffer();

                    const reader = vtk.IO.XML.vtkXMLPolyDataReader.newInstance();
                    reader.parseAsArrayBuffer(fileContents);

                    const mapper = vtk.Rendering.Core.vtkMapper.newInstance({ scalarVisibility: false });
                    mapper.setInputConnection(reader.getOutputPort());

                    const actor = vtk.Rendering.Core.vtkActor.newInstance();
                    actor.setMapper(mapper);

                    const renderer = vtk.Rendering.Core.vtkRenderer.newInstance({ background: [0.2, 0.3, 0.4] });
                    renderer.addActor(actor);
                    renderer.resetCamera();

                    //const renderWindow = vtkRenderWindow.newInstance();
                    renderWindow.addRenderer(renderer);

                    const dims = container.getBoundingClientRect();
                    openglRenderWindow.setSize(dims.width, dims.height);

                    const interactor = vtk.Rendering.Core.vtkRenderWindowInteractor.newInstance();
                    interactor.setView(openglRenderWindow);
                    interactor.initialize();
                    interactor.bindEvents(container);
                    interactor.setInteractorStyle(vtk.Interaction.Style.vtkInteractorStyleTrackballCamera.newInstance());
                    interactor.start(); // Start handling events

                    renderWindow.render();

                    // Define cleanup function to release VTK resources
                    vtkCleanup = () => {
                        renderWindow.delete();
                        openglRenderWindow.delete();
                    };

                } catch (error) {
                    console.error('VTK rendering error:', error);
                    fileContentDiv.innerHTML = `<p style="color: red;">Failed to render VTP file: ${error.message}</p>`;
                }
            } else {
                try {
                    const response = await fetch(`/api/s3/view/${key}`);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Failed to parse error JSON.' }));
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    const content = await response.text();
                    fileContentDiv.innerHTML = `<pre>${escapeHtml(content)}</pre>`;
                } catch (error) {
                    console.error('View file error:', error);
                    fileContentDiv.innerHTML = `<p style="color: red;">Failed to load file: ${error.message}</p>`;
                }
            }

            const closeModal = () => {
                vtkCleanup(); // Clean up VTK resources if they exist
                modal.style.display = 'none';
                fileContentDiv.innerHTML = '';
            };

            closeButton.onclick = closeModal;
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeModal();
                }
            }
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

    </script>
    <div id="file-viewer-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="file-content"></div>
        </div>
    </div>
    <input type="file" id="s3-upload-input" style="display: none;" multiple>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>
        function setActiveTab(tabName) {
            // Hide all content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Deactivate all tabs
            document.querySelectorAll('nav button').forEach(button => {
                button.classList.remove('bg-[#E2E8F0]', 'text-[#2C3E50]');
                button.classList.add('text-[#4A5568]', 'hover:bg-[#F7FAFC]');
            });

            // Activate the selected tab and content
            const tabContent = document.getElementById(`${tabName}-content`);
            tabContent.classList.remove('hidden');
            document.getElementById(`${tabName}-tab`).classList.add('bg-[#E2E8F0]', 'text-[#2C3E50]');
            document.getElementById(`${tabName}-tab`).classList.remove('text-[#4A5568]', 'hover:bg-[#F7FAFC]');

            lucide.createIcons({ root: tabContent });
        }
        function loadNotifications() {
            const notifications = [
                { id: 1, text: 'Job "CFD Simulation v2" is now running', time: '5 min ago' },
                { id: 2, text: 'Job "Test OpenFOAM Job" completed successfully', time: '2 hours ago' },
                { id: 3, text: 'Spend limit at 68% ($68/$100)', time: '1 day ago' },
            ];
            const dropdown = document.querySelector('#notifications-dropdown .max-h-96');
            dropdown.innerHTML = notifications.map(notif => `
                <div class="p-4 border-b border-[#E2E8F0] hover:bg-[#F7FAFC]">
                    <p class="text-sm text-[#2C3E50]">${notif.text}</p>
                    <p class="text-xs text-[#4A5568] mt-1">${notif.time}</p>
                </div>
            `).join('');
        }

        function toggleNotifications() {
            document.getElementById('notifications-dropdown').classList.toggle('hidden');
        }
        function getStatusIcon(status) {
            switch(status) {
                case 'COMPLETED': return 'check-circle';
                case 'SUCCEEDED': return 'check-circle';
                case 'RUNNING': return 'play';
                case 'PENDING': return 'clock';
                case 'QUEUED': return 'clock';
                case 'SUBMITTED': return 'clock';
                case 'RUNNABLE': return 'clock';
                case 'STARTING': return 'clock';
                case 'PROVISIONING': return 'clock';
                case 'FAILED': return 'alert-circle';
                default: return 'help-circle';
            }
        }

        function getStatusColor(status) {
            switch(status) {
                case 'COMPLETED': return 'bg-[#10B981]/10 text-[#10B981] border-[#10B981]/20';
                case 'SUCCEEDED': return 'bg-[#10B981]/10 text-[#10B981] border-[#10B981]/20';
                case 'RUNNING': return 'bg-[#3B82F6]/10 text-[#3B82F6] border-[#3B82F6]/20';
                case 'PENDING': return 'bg-[#F59E0B]/10 text-[#F59E0B] border-[#F59E0B]/20';
                case 'QUEUED': return 'bg-[#F59E0B]/10 text-[#F59E0B] border-[#F59E0B]/20';
                case 'SUBMITTED': return 'bg-[#F59E0B]/10 text-[#F59E0B] border-[#F59E0B]/20';
                case 'RUNNABLE': return 'bg-[#F59E0B]/10 text-[#F59E0B] border-[#F59E0B]/20';
                case 'STARTING': return 'bg-[#F59E0B]/10 text-[#F59E0B] border-[#F59E0B]/20';
                case 'PROVISIONING': return 'bg-[#F59E0B]/10 text-[#F59E0B] border-[#F59E0B]/20';
                case 'FAILED': return 'bg-[#EF4444]/10 text-[#EF4444] border-[#EF4444]/20';
                default: return 'bg-[#A0AEC0]/10 text-[#4A5568] border-[#A0AEC0]/20';
            }
        }
    </script>
</body>
</html>